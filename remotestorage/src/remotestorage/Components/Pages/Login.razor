@page "/login"
@using System.Reflection.Metadata
@using remotestorage.Components.Layout
@layout EmptyLayout
@rendermode InteractiveServer

@inject IJSRuntime JSRuntime
@inject Blazored.LocalStorage.ILocalStorageService localStore
@inject AuthenticationService.JwtService JwtService

<div class="page-wrapper">

    <div class="login-container">
        <div class="top-row-logo">
            <img src="/images/logo.png" class="logo-img"/>
            <span>GuiFotosâ„¢</span>
        </div>

        <div class="login-form">
            <h1>Log in</h1>
            
            <form @onsubmit="OnSubmitLoginForm">
                <div class="input-option">
                    <label for = "username-id">Username: </label>
                    <input type="text" @bind="username" class="input-box" placeholder="Enter your username" id = "username-id"/>
                </div>

                <div class="input-option password-field">
                    <label for="password-id">Password:</label>
                    <div class="password-wrapper">
                        <input 
                            type="@(hiddenPassword ? "password" : "text")"
                            class="input-box" 
                            placeholder="Enter your password" 
                            id="password-id"
                            @bind="password"
                        />
                        <button type="button" class="toggle-password" @onclick="OnTogglePassword">
                            @(hiddenPassword ? "Show" : "Hide")
                        </button>
                    </div>
                </div>
                
                <button type="submit" class="submit-button">Log in</button>    

                <p>Don't have an account? <a href="/register">Click here</a></p>

                @if(!String.IsNullOrEmpty(errorMessage)) {
                    <p>@errorMessage</p>
                }
            </form>
        </div>
    </div> 
</div>

@code {
    [Inject] private NavigationManager Navigation { get; set; } = default!;
    [Inject] public HttpClient Http { get; set; } = default!;
    [Inject] public IConfiguration Configuration { get; set; } = default!;

    private string ApiUrl = string.Empty;
    private bool hiddenPassword = true;
    private bool isLoading = false;
    
    private string username = string.Empty;
    private string password = string.Empty;
    private string? errorMessage = null;

    protected override void OnInitialized()
    {
        ApiUrl = Environment.GetEnvironmentVariable("API_DOCKER_URL") ?? Configuration.GetValue<string>("API_BASE_URL");
        Http.BaseAddress = new Uri(ApiUrl);
    }

    private void OnTogglePassword () {
        hiddenPassword = !hiddenPassword;
    }

    private async Task LogMessage(string msg)
    {
        await JSRuntime.InvokeVoidAsync("console.log", msg);
    }

    private async Task OnSubmitLoginForm (EventArgs e) 
    {
        errorMessage = null;

        if (!ValidateForm())
        {
            return;
        }

        try 
        {
            HttpResponseMessage? response = await Http.PostAsJsonAsync("api/auth/login", new
            {
                username,
                password
            });

            if (response.IsSuccessStatusCode)
            {
                string ContentString = await response.Content.ReadAsStringAsync();
                
                await LogMessage(ContentString);

                Models.TokenResponse? json = await response.Content.ReadFromJsonAsync<Models.TokenResponse>();
                var sessionToken = json?.Token;

                if (sessionToken != null)
                    await JwtService.SaveTokenAsync(sessionToken);

                return;
            }

            await HandleErrorResponse(response);
        }
        catch (HttpRequestException ex)
        {
            errorMessage = "Unable to connect to server.";
            Console.WriteLine($"HTTP Request Error: {ex.Message}");
        }
        catch (Exception ex)
        {
            errorMessage = "An unexpected error occurred.";
            Console.WriteLine($"Error during registration: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }

    }

    private bool ValidateForm()
    {
        // Check if fields are empty
        if (string.IsNullOrWhiteSpace(username))
        {
            errorMessage = "Username is required";
            return false;
        }

        if (string.IsNullOrWhiteSpace(password))
        {
            errorMessage = "Password is required";
            return false;
        }

        return true;
    }

    private async Task HandleErrorResponse(HttpResponseMessage response)
    {
        switch (response.StatusCode)
        {
            case System.Net.HttpStatusCode.Conflict:
                errorMessage = "Invalid username or password.";
                break;
            
            case System.Net.HttpStatusCode.BadRequest:
                try
                {
                    var error = await response.Content.ReadFromJsonAsync<Dictionary<string, object>>();
                    if (error != null && error.TryGetValue("message", out var msg))
                    {
                        errorMessage = msg.ToString();
                    }
                    else
                    {
                        errorMessage = "Invalid registration data.";
                    }
                }
                catch
                {
                    errorMessage = "Invalid registration data.";
                }
                break;
            
            case System.Net.HttpStatusCode.InternalServerError:
                errorMessage = "Internal server error.";
                break;
            
            default:
                errorMessage = $"Registration failed. (Status: {response.StatusCode})";
                break;
        }
    }


    
}